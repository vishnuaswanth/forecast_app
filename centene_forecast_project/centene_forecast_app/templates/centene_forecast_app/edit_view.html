{% extends 'index.html' %}
{% load static %}

{# Note: user_name, timezone, utcoffset, tz_fullname, tz_abbreviation #}
{# are automatically available via context processor - no need to pass them #}

{% block title %}{{ page_title }}{% endblock %}


{% block content2 %}
<!-- Select2 CSS for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />

    <!-- Edit View Custom CSS -->
    <link rel="stylesheet" href="{% static 'centene_forecast_app/css/edit_view.css' %}">
<!-- Config passed to JavaScript -->
{{ config|json_script:"edit-view-config" }}

<div class="edit-view-container">
    <!-- Header -->
    <div class="edit-view-header edit-view-mb-4">
        <h2 class="edit-view-mb-0">
            <i class="fas fa-edit edit-view-me-2"></i>Edit View - Allocation Management
        </h2>
    </div>

    <!-- Loading Spinner for Initial Data (Dropdowns) -->
    <div class="edit-view-loading edit-view-text-center edit-view-mb-3" id="initial-data-loading" style="display: none;">
        <div class="edit-view-spinner edit-view-spinner-sm edit-view-text-primary" role="status">
            <span class="edit-view-visually-hidden">Loading...</span>
        </div>
        <span class="edit-view-ms-2">Loading dropdown data...</span>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs edit-view-tabs" id="edit-view-tabs" role="tablist">
        <li class="nav-item edit-view-nav-item" role="presentation">
            <button class="nav-link active edit-view-nav-link" id="bench-allocation-tab-btn" data-bs-toggle="tab"
                    data-bs-target="#bench-allocation-tab" type="button" role="tab"
                    aria-controls="bench-allocation-tab" aria-selected="true">
                <i class="fas fa-users edit-view-me-2"></i>Bench Allocation
            </button>
        </li>
        <li class="nav-item edit-view-nav-item" role="presentation">
            <button class="nav-link edit-view-nav-link" id="target-cph-tab-btn" data-bs-toggle="tab"
                    data-bs-target="#target-cph-tab" type="button" role="tab"
                    aria-controls="target-cph-tab" aria-selected="false">
                <i class="fas fa-dollar-sign edit-view-me-2"></i>Target CPH
            </button>
        </li>
        <li class="nav-item edit-view-nav-item" role="presentation">
            <button class="nav-link edit-view-nav-link" id="forecast-reallocation-tab-btn" data-bs-toggle="tab"
                    data-bs-target="#forecast-reallocation-tab" type="button" role="tab"
                    aria-controls="forecast-reallocation-tab" aria-selected="false">
                <i class="fas fa-exchange-alt edit-view-me-2"></i>Forecast Reallocation
            </button>
        </li>
        <li class="nav-item edit-view-nav-item" role="presentation">
            <button class="nav-link edit-view-nav-link" id="history-log-tab-btn" data-bs-toggle="tab"
                    data-bs-target="#history-log-tab" type="button" role="tab"
                    aria-controls="history-log-tab" aria-selected="false">
                <i class="fas fa-history edit-view-me-2"></i>History Log
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content edit-view-tab-content edit-view-mt-3" id="edit-view-tab-content">

        <!-- ========================================== -->
        <!-- BENCH ALLOCATION TAB -->
        <!-- ========================================== -->
        <div class="tab-pane fade show active edit-view-tab-pane" id="bench-allocation-tab" role="tabpanel"
             aria-labelledby="bench-allocation-tab-btn">

            <!-- Filter Section -->
            <div class="edit-view-card edit-view-filter-card">
                <div class="edit-view-card-body">
                    <h5 class="edit-view-mb-3">
                        <i class="fas fa-filter edit-view-me-2"></i>Allocation Report Selection
                    </h5>
                    <div class="edit-view-row edit-view-align-end">
                        <div class="edit-view-col-6">
                            <label class="edit-view-form-label" for="allocation-report-select">
                                Select Allocation Report:
                            </label>
                            <select class="edit-view-form-select edit-view-select2" id="allocation-report-select"
                                    data-placeholder="-- Select Report Month --">
                                <option value="">-- Select Report Month --</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="edit-view-col-3">
                            <button class="edit-view-btn edit-view-btn-primary" id="run-allocation-btn">
                                <i class="fas fa-play edit-view-me-1"></i>Run Allocation
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Alert -->
            <div class="edit-view-alert edit-view-alert-info edit-view-info-alert edit-view-mt-3">
                <i class="fas fa-info-circle edit-view-me-2"></i>
                <strong>How it works:</strong> Click "Run Allocation" to automatically identify and allocate
                excess bench resources. The system will display only the rows that will be modified.
            </div>

            <!-- Loading Spinner for Preview -->
            <div class="edit-view-loading edit-view-text-center" id="preview-loading" style="display: none;">
                <div class="edit-view-spinner edit-view-text-primary" role="status">
                    <span class="edit-view-visually-hidden">Loading...</span>
                </div>
                <p class="edit-view-mt-2">Calculating bench allocation preview...</p>
            </div>

            <!-- Error Alert for Preview -->
            <div class="edit-view-alert edit-view-alert-danger edit-view-error-alert" id="preview-error" style="display: none;">
                <i class="fas fa-exclamation-circle edit-view-me-2"></i>
                <span id="preview-error-message">An error occurred</span>
            </div>

            <!-- Preview Section -->
            <div class="edit-view-card edit-view-preview-container edit-view-mt-3" id="preview-container" style="display: none;">
                <div class="edit-view-card-header edit-view-preview-header">
                    <div class="edit-view-flex edit-view-justify-between edit-view-align-center">
                        <h5 class="edit-view-mb-0">
                            <i class="fas fa-eye edit-view-me-2"></i>Preview of Changes
                        </h5>
                        <span class="edit-view-badge edit-view-badge-info" id="modified-count-badge">0 records modified</span>
                    </div>
                    <p class="edit-view-text-muted edit-view-mb-0 edit-view-mt-2">
                        The following rows will be modified based on automatically allocated excess bench resources.
                    </p>
                </div>
                <div class="edit-view-card-body">
                    <!-- Preview Filters -->
                    <div class="edit-view-preview-filters edit-view-mb-3" id="preview-filters" style="display: none;">
                        <div class="edit-view-row edit-view-align-end">
                            <div class="edit-view-col-4">
                                <label class="edit-view-form-label" for="preview-lob-filter">
                                    Filter by LOB:
                                </label>
                                <select class="edit-view-form-select edit-view-select2-multi-checkbox"
                                        id="preview-lob-filter" multiple
                                        data-placeholder="All LOBs">
                                    <!-- Options populated by JavaScript -->
                                </select>
                            </div>
                            <div class="edit-view-col-4">
                                <label class="edit-view-form-label" for="preview-case-type-filter">
                                    Filter by Case Type:
                                </label>
                                <select class="edit-view-form-select edit-view-select2-multi-checkbox"
                                        id="preview-case-type-filter" multiple
                                        data-placeholder="All Case Types">
                                    <!-- Options populated by JavaScript -->
                                </select>
                            </div>
                            <div class="edit-view-col-2">
                                <button class="edit-view-btn edit-view-btn-outline-secondary edit-view-btn-sm"
                                        id="clear-preview-filters-btn">
                                    <i class="fas fa-times edit-view-me-1"></i>Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Alert -->
                    <div class="edit-view-alert edit-view-alert-success edit-view-mt-3" id="preview-summary">
                        <strong>Summary:</strong> <span id="summary-text">0 records modified</span>
                    </div>

                    <!-- Preview Table -->
                    <div class="edit-view-table-container">
                        <table class="edit-view-preview-table edit-view-preview-table-fixed" id="preview-table">
                            <thead id="preview-table-head">
                                <!-- Headers will be populated by JavaScript -->
                            </thead>
                            <tbody id="preview-table-body">
                                <!-- Rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Month-wise Changes Summary -->
                    <div class="edit-view-overall-changes edit-view-mt-3" id="overall-changes" style="display: none;">
                        <div class="edit-view-row">
                            <div class="edit-view-col-8">
                                <div class="edit-view-summary-card">
                                    <h6>Month-wise Changes Summary</h6>
                                    <div class="edit-view-month-changes-container" id="month-changes-container">
                                        <!-- Month-wise changes will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="edit-view-col-4">
                                <div class="edit-view-legend-card">
                                    <h6>Abbreviations</h6>
                                    <ul>
                                        <li><strong>CF:</strong> Client Forecast</li>
                                        <li><strong>FTE Req:</strong> FTE Required</li>
                                        <li><strong>FTE Avail:</strong> FTE Available</li>
                                        <li><strong>Cap:</strong> Capacity</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <nav id="preview-pagination" class="edit-view-preview-pagination" style="display: none;">
                        <ul class="edit-view-pagination edit-view-pagination-sm edit-view-justify-end">
                            <!-- Pagination items will be populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>

            <!-- Actions Section (Accept/Reject) -->
            <div class="edit-view-card edit-view-actions-container edit-view-mt-3" id="actions-container" style="display: none;">
                <div class="edit-view-card-body">
                    <h5 class="edit-view-mb-3">
                        <i class="fas fa-check-circle edit-view-me-2"></i>Review and Submit
                    </h5>

                    <!-- User Notes Textarea -->
                    <div class="edit-view-mb-3">
                        <label class="edit-view-form-label" for="user-notes-input">
                            Change Description (Optional):
                        </label>
                        <textarea class="edit-view-form-input" id="user-notes-input" rows="3"
                                  maxlength="500" placeholder="Add notes about this allocation (max 500 characters)..."></textarea>
                        <small class="edit-view-form-text edit-view-text-muted">
                            <span id="notes-char-count">0</span> / 500 characters
                        </small>
                    </div>

                    <!-- Action Buttons -->
                    <div class="edit-view-flex edit-view-justify-between edit-view-align-center">
                        <div>
                            <strong>Total Modified Records:</strong> <span id="action-summary-count">0</span>
                        </div>
                        <div>
                            <button class="edit-view-btn edit-view-btn-outline-secondary edit-view-me-2" id="reject-btn">
                                <i class="fas fa-times edit-view-me-1"></i>Reject
                            </button>
                            <button class="edit-view-btn edit-view-btn-success" id="accept-btn">
                                <i class="fas fa-check edit-view-me-1"></i>Accept & Update
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ========================================== -->
        <!-- TARGET CPH TAB -->
        <!-- ========================================== -->
        <div class="tab-pane fade edit-view-tab-pane" id="target-cph-tab" role="tabpanel"
             aria-labelledby="target-cph-tab-btn">

            <!-- Filter Section -->
            <div class="edit-view-card edit-view-filter-card">
                <div class="edit-view-card-body">
                    <h5 class="edit-view-mb-3">
                        <i class="fas fa-filter edit-view-me-2"></i>Target CPH Data Selection
                    </h5>
                    <div class="edit-view-row edit-view-align-end">
                        <div class="edit-view-col-6">
                            <label class="edit-view-form-label" for="cph-report-select">
                                Select Allocation Report:
                            </label>
                            <select class="edit-view-form-select edit-view-select2" id="cph-report-select"
                                    data-placeholder="-- Select Report Month --">
                                <option value="">-- Select Report Month --</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="edit-view-col-3">
                            <button class="edit-view-btn edit-view-btn-primary" id="load-cph-data-btn">
                                <i class="fas fa-download edit-view-me-1"></i>Load CPH Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Alert -->
            <div class="edit-view-alert edit-view-alert-info edit-view-info-alert edit-view-mt-3">
                <i class="fas fa-info-circle edit-view-me-2"></i>
                <strong>How it works:</strong> Load CPH data for a selected report, modify target CPH values
                using the input fields or increment/decrement buttons, then generate a preview to see the
                forecast impact before submitting.
            </div>

            <!-- Loading Spinner for CPH Data -->
            <div class="edit-view-loading edit-view-text-center" id="cph-data-loading" style="display: none;">
                <div class="edit-view-spinner edit-view-text-primary" role="status">
                    <span class="edit-view-visually-hidden">Loading...</span>
                </div>
                <p class="edit-view-mt-2">Loading CPH data...</p>
            </div>

            <!-- Error Alert for CPH Data -->
            <div class="edit-view-alert edit-view-alert-danger edit-view-error-alert" id="cph-data-error" style="display: none;">
                <i class="fas fa-exclamation-circle edit-view-me-2"></i>
                <span id="cph-data-error-message">An error occurred</span>
            </div>

            <!-- CPH Data Table Section -->
            <div class="edit-view-card edit-view-mt-3" id="cph-data-container" style="display: none;">
                <div class="edit-view-card-header">
                    <div class="edit-view-flex edit-view-justify-between edit-view-align-center">
                        <h5 class="edit-view-mb-0">
                            <i class="fas fa-table edit-view-me-2"></i>Target CPH Values
                        </h5>
                        <span class="edit-view-badge edit-view-badge-warning" id="cph-modified-count-badge">0 modified</span>
                    </div>
                </div>
                <div class="edit-view-card-body">
                    <!-- CPH Filters -->
                    <div class="edit-view-cph-filters edit-view-mb-3" id="cph-filters">
                        <div class="edit-view-row edit-view-align-end">
                            <div class="edit-view-col-4">
                                <label class="edit-view-form-label" for="cph-lob-filter">
                                    Filter by LOB:
                                </label>
                                <select class="edit-view-form-select edit-view-select2-multi-checkbox"
                                        id="cph-lob-filter" multiple
                                        data-placeholder="All LOBs">
                                    <!-- Options populated by JavaScript -->
                                </select>
                            </div>
                            <div class="edit-view-col-4">
                                <label class="edit-view-form-label" for="cph-case-type-filter">
                                    Filter by Case Type:
                                </label>
                                <select class="edit-view-form-select edit-view-select2-multi-checkbox"
                                        id="cph-case-type-filter" multiple
                                        data-placeholder="All Case Types">
                                    <!-- Options populated by JavaScript -->
                                </select>
                            </div>
                            <div class="edit-view-col-2">
                                <button class="edit-view-btn edit-view-btn-outline-secondary edit-view-btn-sm"
                                        id="clear-cph-filters-btn">
                                    <i class="fas fa-times edit-view-me-1"></i>Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- CPH Table -->
                    <div class="edit-view-table-container">
                        <table class="edit-view-cph-table" id="cph-table">
                            <thead>
                                <tr>
                                    <th class="edit-view-cph-lob-col">LOB</th>
                                    <th class="edit-view-cph-case-type-col">Case Type</th>
                                    <th class="edit-view-cph-target-col">Target CPH</th>
                                    <th class="edit-view-cph-modified-col">Modified Target CPH</th>
                                </tr>
                            </thead>
                            <tbody id="cph-table-body">
                                <!-- Rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav id="cph-pagination" class="edit-view-mt-3" style="display: none;">
                        <ul class="edit-view-pagination edit-view-cph-pagination edit-view-pagination-sm edit-view-justify-end">
                            <!-- Pagination items will be populated by JavaScript -->
                        </ul>
                    </nav>

                    <!-- Submit Button -->
                    <div class="edit-view-text-center edit-view-mt-4">
                        <button class="edit-view-btn edit-view-btn-success" id="submit-cph-changes-btn" disabled>
                            <i class="fas fa-eye edit-view-me-1"></i>Generate Preview
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner for CPH Preview -->
            <div class="edit-view-loading edit-view-text-center edit-view-mt-3" id="cph-preview-loading" style="display: none;">
                <div class="edit-view-spinner edit-view-text-primary" role="status">
                    <span class="edit-view-visually-hidden">Loading...</span>
                </div>
                <p class="edit-view-mt-2">Calculating CPH impact preview...</p>
            </div>

            <!-- Error Alert for CPH Preview -->
            <div class="edit-view-alert edit-view-alert-danger edit-view-error-alert edit-view-mt-3" id="cph-preview-error" style="display: none;">
                <i class="fas fa-exclamation-circle edit-view-me-2"></i>
                <span id="cph-preview-error-message">An error occurred</span>
            </div>

            <!-- CPH Preview Section -->
            <div class="edit-view-card edit-view-preview-container edit-view-mt-3" id="cph-preview-container" style="display: none;">
                <div class="edit-view-card-header edit-view-preview-header">
                    <div class="edit-view-flex edit-view-justify-between edit-view-align-center">
                        <h5 class="edit-view-mb-0">
                            <i class="fas fa-eye edit-view-me-2"></i>Forecast Impact Preview
                        </h5>
                        <span class="edit-view-badge edit-view-badge-info" id="cph-preview-modified-count-badge">0 forecast rows affected</span>
                    </div>
                    <p class="edit-view-text-muted edit-view-mb-0 edit-view-mt-2">
                        The following forecast rows will be affected by the CPH changes.
                    </p>
                </div>
                <div class="edit-view-card-body">
                    <!-- CPH Preview Filters -->
                    <div class="edit-view-preview-filters edit-view-mb-3" id="cph-preview-filters" style="display: none;">
                        <div class="edit-view-row edit-view-align-end">
                            <div class="edit-view-col-4">
                                <label class="edit-view-form-label" for="cph-preview-lob-filter">
                                    Filter by LOB:
                                </label>
                                <select class="edit-view-form-select edit-view-select2-multi-checkbox"
                                        id="cph-preview-lob-filter" multiple
                                        data-placeholder="All LOBs">
                                    <!-- Options populated by JavaScript -->
                                </select>
                            </div>
                            <div class="edit-view-col-4">
                                <label class="edit-view-form-label" for="cph-preview-case-type-filter">
                                    Filter by Case Type:
                                </label>
                                <select class="edit-view-form-select edit-view-select2-multi-checkbox"
                                        id="cph-preview-case-type-filter" multiple
                                        data-placeholder="All Case Types">
                                    <!-- Options populated by JavaScript -->
                                </select>
                            </div>
                            <div class="edit-view-col-2">
                                <button class="edit-view-btn edit-view-btn-outline-secondary edit-view-btn-sm"
                                        id="clear-cph-preview-filters-btn">
                                    <i class="fas fa-times edit-view-me-1"></i>Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Alert -->
                    <div class="edit-view-alert edit-view-alert-success edit-view-mt-3" id="cph-preview-summary">
                        <strong>Summary:</strong> <span id="cph-summary-text">0 forecast rows affected</span>
                    </div>

                    <!-- CPH Preview Table -->
                    <div class="edit-view-table-container">
                        <table class="edit-view-preview-table edit-view-preview-table-fixed" id="cph-preview-table">
                            <thead id="cph-preview-table-head">
                                <!-- Headers will be populated by JavaScript -->
                            </thead>
                            <tbody id="cph-preview-table-body">
                                <!-- Rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Month-wise Changes Summary -->
                    <div class="edit-view-overall-changes edit-view-mt-3" id="cph-overall-changes" style="display: none;">
                        <div class="edit-view-row">
                            <div class="edit-view-col-8">
                                <div class="edit-view-summary-card">
                                    <h6>Month-wise Changes Summary</h6>
                                    <div class="edit-view-month-changes-container" id="cph-month-changes-container">
                                        <!-- Month-wise changes will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="edit-view-col-4">
                                <div class="edit-view-legend-card">
                                    <h6>Abbreviations</h6>
                                    <ul>
                                        <li><strong>CF:</strong> Client Forecast</li>
                                        <li><strong>FTE Req:</strong> FTE Required</li>
                                        <li><strong>FTE Avail:</strong> FTE Available</li>
                                        <li><strong>Cap:</strong> Capacity</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <nav id="cph-preview-pagination" class="edit-view-cph-preview-pagination" style="display: none;">
                        <ul class="edit-view-pagination edit-view-pagination-sm edit-view-justify-end">
                            <!-- Pagination items will be populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>

            <!-- CPH Actions Section (Accept/Reject) -->
            <div class="edit-view-card edit-view-actions-container edit-view-mt-3" id="cph-actions-container" style="display: none;">
                <div class="edit-view-card-body">
                    <h5 class="edit-view-mb-3">
                        <i class="fas fa-check-circle edit-view-me-2"></i>Review and Submit CPH Changes
                    </h5>

                    <!-- User Notes Textarea -->
                    <div class="edit-view-mb-3">
                        <label class="edit-view-form-label" for="cph-user-notes-input">
                            Change Description (Optional):
                        </label>
                        <textarea class="edit-view-form-input" id="cph-user-notes-input" rows="3"
                                  maxlength="500" placeholder="Add notes about these CPH changes (max 500 characters)..."></textarea>
                        <small class="edit-view-form-text edit-view-text-muted">
                            <span id="cph-notes-char-count">0</span> / 500 characters
                        </small>
                    </div>

                    <!-- Action Buttons -->
                    <div class="edit-view-flex edit-view-justify-between edit-view-align-center">
                        <div>
                            <strong>CPH Changes:</strong> <span id="cph-action-summary-count">0</span> |
                            <strong>Forecast Rows Affected:</strong> <span id="cph-forecast-rows-count">0</span>
                        </div>
                        <div>
                            <button class="edit-view-btn edit-view-btn-outline-secondary edit-view-me-2" id="cph-reject-btn">
                                <i class="fas fa-times edit-view-me-1"></i>Reject
                            </button>
                            <button class="edit-view-btn edit-view-btn-success" id="cph-accept-btn">
                                <i class="fas fa-check edit-view-me-1"></i>Accept & Update
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ========================================== -->
        <!-- FORECAST REALLOCATION TAB -->
        <!-- ========================================== -->
        <div class="tab-pane fade edit-view-tab-pane" id="forecast-reallocation-tab" role="tabpanel"
             aria-labelledby="forecast-reallocation-tab-btn">

            <!-- Filter Section -->
            <div class="edit-view-card edit-view-filter-card">
                <div class="edit-view-card-body">
                    <h5 class="edit-view-mb-3">
                        <i class="fas fa-filter edit-view-me-2"></i>Forecast Reallocation - Data Selection
                    </h5>
                    <div class="edit-view-row edit-view-align-end">
                        <div class="edit-view-col-3">
                            <label class="edit-view-form-label" for="reallocation-report-select">
                                Select Report Month:
                            </label>
                            <select class="edit-view-form-select edit-view-select2" id="reallocation-report-select"
                                    data-placeholder="-- Select Report Month --">
                                <option value="">-- Select Report Month --</option>
                            </select>
                        </div>
                        <div class="edit-view-col-2">
                            <label class="edit-view-form-label" for="reallocation-lob-filter">
                                Main LOB:
                            </label>
                            <select class="edit-view-form-select edit-view-select2-multi-checkbox"
                                    id="reallocation-lob-filter" multiple
                                    data-placeholder="All LOBs">
                            </select>
                        </div>
                        <div class="edit-view-col-2">
                            <label class="edit-view-form-label" for="reallocation-case-type-filter">
                                Case Type:
                            </label>
                            <select class="edit-view-form-select edit-view-select2-multi-checkbox"
                                    id="reallocation-case-type-filter" multiple
                                    data-placeholder="All Case Types">
                            </select>
                        </div>
                        <div class="edit-view-col-2">
                            <label class="edit-view-form-label" for="reallocation-state-filter">
                                State:
                            </label>
                            <select class="edit-view-form-select edit-view-select2-multi-checkbox"
                                    id="reallocation-state-filter" multiple
                                    data-placeholder="All States">
                            </select>
                        </div>
                        <div class="edit-view-col-2">
                            <button class="edit-view-btn edit-view-btn-primary" id="load-reallocation-data-btn">
                                <i class="fas fa-download edit-view-me-1"></i>Load Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Alert -->
            <div class="edit-view-alert edit-view-alert-info edit-view-info-alert edit-view-mt-3">
                <i class="fas fa-info-circle edit-view-me-2"></i>
                <strong>How it works:</strong> Load data for a selected report, edit <strong>Target CPH</strong> and
                <strong>FTE Available</strong> values using the input fields or Â± buttons, then generate a preview
                to see the impact before submitting. Use the month visibility checkboxes to show/hide specific months.
            </div>

            <!-- Loading Spinner for Reallocation Data -->
            <div class="edit-view-loading edit-view-text-center" id="reallocation-data-loading" style="display: none;">
                <div class="edit-view-spinner edit-view-text-primary" role="status">
                    <span class="edit-view-visually-hidden">Loading...</span>
                </div>
                <p class="edit-view-mt-2">Loading reallocation data...</p>
            </div>

            <!-- Error Alert for Reallocation Data -->
            <div class="edit-view-alert edit-view-alert-danger edit-view-error-alert" id="reallocation-data-error" style="display: none;">
                <i class="fas fa-exclamation-circle edit-view-me-2"></i>
                <span id="reallocation-data-error-message">An error occurred</span>
            </div>

            <!-- Reallocation Data Table Section -->
            <div class="edit-view-card edit-view-mt-3" id="reallocation-data-container" style="display: none;">
                <div class="edit-view-card-header">
                    <div class="edit-view-flex edit-view-justify-between edit-view-align-center">
                        <h5 class="edit-view-mb-0">
                            <i class="fas fa-table edit-view-me-2"></i>Editable Forecast Data
                        </h5>
                        <span class="edit-view-badge edit-view-badge-warning" id="reallocation-modified-count-badge">0 modified</span>
                    </div>
                </div>
                <div class="edit-view-card-body">
                    <!-- Month Visibility Checkboxes -->
                    <div class="edit-view-month-selector edit-view-mb-3" id="reallocation-month-selector">
                        <label class="edit-view-form-label"><strong>Visible Months:</strong></label>
                        <div class="edit-view-month-checkboxes" id="reallocation-month-checkboxes">
                            <!-- Checkboxes will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Reallocation Table with Frozen Columns -->
                    <div class="edit-view-table-container edit-view-table-frozen-container">
                        <table class="edit-view-reallocation-table edit-view-table-frozen" id="reallocation-table">
                            <thead id="reallocation-table-head">
                                <!-- Headers will be populated by JavaScript -->
                            </thead>
                            <tbody id="reallocation-table-body">
                                <!-- Rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav id="reallocation-pagination" class="edit-view-mt-3" style="display: none;">
                        <ul class="edit-view-pagination edit-view-reallocation-pagination edit-view-pagination-sm edit-view-justify-end">
                            <!-- Pagination items will be populated by JavaScript -->
                        </ul>
                    </nav>

                    <!-- Submit Button -->
                    <div class="edit-view-text-center edit-view-mt-4">
                        <button class="edit-view-btn edit-view-btn-success" id="show-reallocation-preview-btn" disabled>
                            <i class="fas fa-eye edit-view-me-1"></i>Show Preview
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner for Reallocation Preview -->
            <div class="edit-view-loading edit-view-text-center edit-view-mt-3" id="reallocation-preview-loading" style="display: none;">
                <div class="edit-view-spinner edit-view-text-primary" role="status">
                    <span class="edit-view-visually-hidden">Loading...</span>
                </div>
                <p class="edit-view-mt-2">Calculating reallocation preview...</p>
            </div>

            <!-- Error Alert for Reallocation Preview -->
            <div class="edit-view-alert edit-view-alert-danger edit-view-error-alert edit-view-mt-3" id="reallocation-preview-error" style="display: none;">
                <i class="fas fa-exclamation-circle edit-view-me-2"></i>
                <span id="reallocation-preview-error-message">An error occurred</span>
            </div>

            <!-- Reallocation Preview Section -->
            <div class="edit-view-card edit-view-preview-container edit-view-mt-3" id="reallocation-preview-container" style="display: none;">
                <div class="edit-view-card-header edit-view-preview-header">
                    <div class="edit-view-flex edit-view-justify-between edit-view-align-center">
                        <h5 class="edit-view-mb-0">
                            <i class="fas fa-eye edit-view-me-2"></i>Preview of Changes
                        </h5>
                        <span class="edit-view-badge edit-view-badge-info" id="reallocation-preview-modified-count-badge">0 records modified</span>
                    </div>
                    <p class="edit-view-text-muted edit-view-mb-0 edit-view-mt-2">
                        The following rows will be modified based on your changes.
                    </p>
                </div>
                <div class="edit-view-card-body">
                    <!-- Reallocation Preview Filters -->
                    <div class="edit-view-preview-filters edit-view-mb-3" id="reallocation-preview-filters" style="display: none;">
                        <div class="edit-view-row edit-view-align-end">
                            <div class="edit-view-col-4">
                                <label class="edit-view-form-label" for="reallocation-preview-lob-filter">
                                    Filter by LOB:
                                </label>
                                <select class="edit-view-form-select edit-view-select2-multi-checkbox"
                                        id="reallocation-preview-lob-filter" multiple
                                        data-placeholder="All LOBs">
                                </select>
                            </div>
                            <div class="edit-view-col-4">
                                <label class="edit-view-form-label" for="reallocation-preview-case-type-filter">
                                    Filter by Case Type:
                                </label>
                                <select class="edit-view-form-select edit-view-select2-multi-checkbox"
                                        id="reallocation-preview-case-type-filter" multiple
                                        data-placeholder="All Case Types">
                                </select>
                            </div>
                            <div class="edit-view-col-2">
                                <button class="edit-view-btn edit-view-btn-outline-secondary edit-view-btn-sm"
                                        id="clear-reallocation-preview-filters-btn">
                                    <i class="fas fa-times edit-view-me-1"></i>Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Alert -->
                    <div class="edit-view-alert edit-view-alert-success edit-view-mt-3" id="reallocation-preview-summary">
                        <strong>Summary:</strong> <span id="reallocation-summary-text">0 records modified</span>
                    </div>

                    <!-- Reallocation Preview Table -->
                    <div class="edit-view-table-container">
                        <table class="edit-view-preview-table edit-view-preview-table-fixed" id="reallocation-preview-table">
                            <thead id="reallocation-preview-table-head">
                                <!-- Headers will be populated by JavaScript -->
                            </thead>
                            <tbody id="reallocation-preview-table-body">
                                <!-- Rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Month-wise Changes Summary -->
                    <div class="edit-view-overall-changes edit-view-mt-3" id="reallocation-overall-changes" style="display: none;">
                        <div class="edit-view-row">
                            <div class="edit-view-col-8">
                                <div class="edit-view-summary-card">
                                    <h6>Month-wise Changes Summary</h6>
                                    <div class="edit-view-month-changes-container" id="reallocation-month-changes-container">
                                        <!-- Month-wise changes will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="edit-view-col-4">
                                <div class="edit-view-legend-card">
                                    <h6>Abbreviations</h6>
                                    <ul>
                                        <li><strong>CF:</strong> Client Forecast</li>
                                        <li><strong>FTE Req:</strong> FTE Required</li>
                                        <li><strong>FTE Avail:</strong> FTE Available</li>
                                        <li><strong>Cap:</strong> Capacity</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <nav id="reallocation-preview-pagination" class="edit-view-reallocation-preview-pagination" style="display: none;">
                        <ul class="edit-view-pagination edit-view-pagination-sm edit-view-justify-end">
                            <!-- Pagination items will be populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>

            <!-- Reallocation Actions Section (Accept/Reject) -->
            <div class="edit-view-card edit-view-actions-container edit-view-mt-3" id="reallocation-actions-container" style="display: none;">
                <div class="edit-view-card-body">
                    <h5 class="edit-view-mb-3">
                        <i class="fas fa-check-circle edit-view-me-2"></i>Review and Submit Reallocation Changes
                    </h5>

                    <!-- User Notes Textarea -->
                    <div class="edit-view-mb-3">
                        <label class="edit-view-form-label" for="reallocation-user-notes-input">
                            Change Description (Optional):
                        </label>
                        <textarea class="edit-view-form-input" id="reallocation-user-notes-input" rows="3"
                                  maxlength="500" placeholder="Add notes about this reallocation (max 500 characters)..."></textarea>
                        <small class="edit-view-form-text edit-view-text-muted">
                            <span id="reallocation-notes-char-count">0</span> / 500 characters
                        </small>
                    </div>

                    <!-- Action Buttons -->
                    <div class="edit-view-flex edit-view-justify-between edit-view-align-center">
                        <div>
                            <strong>Total Modified Records:</strong> <span id="reallocation-action-summary-count">0</span>
                        </div>
                        <div>
                            <button class="edit-view-btn edit-view-btn-outline-secondary edit-view-me-2" id="reallocation-reject-btn">
                                <i class="fas fa-times edit-view-me-1"></i>Reject
                            </button>
                            <button class="edit-view-btn edit-view-btn-success" id="reallocation-accept-btn">
                                <i class="fas fa-check edit-view-me-1"></i>Accept & Update
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ========================================== -->
        <!-- HISTORY LOG TAB -->
        <!-- ========================================== -->
        <div class="tab-pane fade edit-view-tab-pane" id="history-log-tab" role="tabpanel"
             aria-labelledby="history-log-tab-btn">

            <!-- Filter Section -->
            <div class="edit-view-card edit-view-filter-card">
                <div class="edit-view-card-body">
                    <h5 class="edit-view-mb-3">
                        <i class="fas fa-filter edit-view-me-2"></i>Filter History
                    </h5>
                    <div class="edit-view-row edit-view-align-end">
                        <div class="edit-view-col-4">
                            <label class="edit-view-form-label" for="history-report-select">
                                Filter by Report:
                            </label>
                            <select class="edit-view-form-select edit-view-select2" id="history-report-select"
                                    data-placeholder="-- All Reports --">
                                <option value="">-- All Reports --</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="edit-view-col-4">
                            <label class="edit-view-form-label" for="history-change-type-select">
                                Filter by Change Type:
                            </label>
                            <select class="edit-view-form-select edit-view-select2-multi" id="history-change-type-select"
                                    multiple data-placeholder="Select change types...">
                                <!-- Options will be populated dynamically by JavaScript -->
                            </select>
                        </div>
                        <div class="edit-view-col-2">
                            <button class="edit-view-btn edit-view-btn-primary edit-view-w-100" id="apply-history-filters-btn">
                                <i class="fas fa-sync-alt edit-view-me-1"></i>Apply
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner for History -->
            <div class="edit-view-loading edit-view-text-center edit-view-mt-3" id="history-loading" style="display: none;">
                <div class="edit-view-spinner edit-view-text-primary" role="status">
                    <span class="edit-view-visually-hidden">Loading...</span>
                </div>
                <p class="edit-view-mt-2">Loading history...</p>
            </div>

            <!-- Error Alert for History -->
            <div class="edit-view-alert edit-view-alert-danger edit-view-error-alert edit-view-mt-3" id="history-error" style="display: none;">
                <i class="fas fa-exclamation-circle edit-view-me-2"></i>
                <span id="history-error-message">An error occurred</span>
            </div>

            <!-- History Cards Container -->
            <div id="history-cards-container" class="edit-view-mt-3">
                <!-- Cards will be dynamically inserted here by JavaScript -->
            </div>

            <!-- No Results Message -->
            <div class="edit-view-alert edit-view-alert-info edit-view-text-center edit-view-mt-3" id="history-no-results" style="display: none;">
                <i class="fas fa-info-circle edit-view-me-2"></i>
                No history entries found for the selected filters.
            </div>

            <!-- Load More Button for Lazy Loading -->
            <div id="history-load-more-container" class="edit-view-text-center edit-view-mt-3" style="display: none;">
                <button class="edit-view-btn edit-view-btn-outline-primary" id="history-load-more-btn">
                    <i class="fas fa-chevron-down edit-view-me-1"></i>Load More
                </button>
                <p class="edit-view-text-muted edit-view-mt-2 edit-view-mb-0">
                    <span id="history-loaded-count">0</span> of <span id="history-total-count">0</span> entries loaded
                </p>
            </div>

        </div>

    </div>
</div>
{% endblock %}

{% block script %}
    <!-- jQuery (required for Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Select2 JS for searchable dropdowns -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Edit View Configuration from Django -->
    <script>
        // Pass Django context to JavaScript
        const CONFIG = JSON.parse(document.getElementById('edit-view-config').textContent);

        window.EDIT_VIEW_CONFIG = {
            urls: {
                allocationReports: '{% url "forecast_app:allocation_reports" %}',
                benchAllocationPreview: '{% url "forecast_app:bench_allocation_preview" %}',
                benchAllocationUpdate: '{% url "forecast_app:bench_allocation_update" %}',
                targetCphData: '{% url "forecast_app:target_cph_data" %}',
                targetCphPreview: '{% url "forecast_app:target_cph_preview" %}',
                targetCphUpdate: '{% url "forecast_app:target_cph_update" %}',
                forecastReallocationFilters: '{% url "forecast_app:forecast_reallocation_filters" %}',
                forecastReallocationData: '{% url "forecast_app:forecast_reallocation_data" %}',
                forecastReallocationPreview: '{% url "forecast_app:forecast_reallocation_preview" %}',
                forecastReallocationUpdate: '{% url "forecast_app:forecast_reallocation_update" %}',
                historyLog: '{% url "forecast_app:history_log" %}',
                downloadHistoryExcel: '{% url "forecast_app:download_history_excel" history_log_id="PLACEHOLDER" %}'.replace('PLACEHOLDER', '{id}'),
                availableChangeTypes: '{% url "forecast_app:available_change_types" %}'
            },
            settings: {
                previewPageSize: CONFIG.preview_page_size || 25,
                historyPageSize: CONFIG.history_page_size || 5,
                historyInitialLoad: CONFIG.history_initial_load || 20,
                historyLazyLoadSize: CONFIG.history_lazy_load_size || 10,
                historyShowMoreThreshold: CONFIG.history_show_more_threshold || 3,
                maxUserNotesLength: CONFIG.max_user_notes_length || 500,
                enableUserNotes: CONFIG.enable_user_notes !== undefined ? CONFIG.enable_user_notes : true
            }
        };
    </script>

    <!-- Edit View JavaScript -->
    <script src="{% static 'centene_forecast_app/js/edit_view.js' %}"></script>
{% endblock %}
